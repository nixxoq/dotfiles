#!/bin/bash

LOGFILE="/tmp/alt_tab.log"

log() {
    echo "$(date +"%Y-%m-%d %H:%M:%S") - $1" >>"$LOGFILE"
}

>"$LOGFILE"
log "Script started."

window_list=$(bspc query -N -d | while read -r window_id; do
    title=$(xprop -id "$window_id" | awk -F ' = ' '/_NET_WM_NAME/ {print $2}' | sed 's/"//g')
    [ -n "$title" ] && echo "$title|$window_id"
done)

log "Window list obtained."

declare -A window_map
while IFS='|' read -r title window_id; do
    window_map["$title"]="$window_id"
done <<<"$window_list"

selected_window=$(printf "%s\n" "${!window_map[@]}" | rofi -dmenu -i -p "Select window:" -theme ~/.config/bspwm/src/rofi-themes/AltTab.rasi)

if [ -n "$selected_window" ]; then
    window_id="${window_map[$selected_window]}"
    log "Selected window: ID=$window_id, Title=$selected_window"

    floating_windows=$(bspc query -N -n .window.floating.local)
    echo "$floating_windows" | grep -q "$window_id" && bspc node "$window_id" -t tiled

    bspc node "$window_id" --focus
    log "Switched to window: ID=$window_id, Title=$selected_window"

    xwininfo_output=$(xwininfo -id "$window_id")
    x=$(echo "$xwininfo_output" | grep "Absolute upper-left X:" | awk '{print $4}')
    y=$(echo "$xwininfo_output" | grep "Absolute upper-left Y:" | awk '{print $4}')
    width=$(echo "$xwininfo_output" | grep "Width:" | awk '{print $2}')
    height=$(echo "$xwininfo_output" | grep "Height:" | awk '{print $2}')

    [ -z "$x" ] || [ -z "$y" ] || [ -z "$width" ] || [ -z "$height" ] && x=0 && y=0 && width=0 && height=0

    center_x=$((x + width / 2))
    center_y=$((y + height / 2))

    log "Window coordinates: X=$x, Y=$y, Width=$width, Height=$height"
    log "Cursor will be moved to center: X=$center_x, Y=$center_y"

    xdotool mousemove $center_x $center_y
    notify-send "Switched to window" "$selected_window"
else
    log "No window selected."
fi

log "Script finished."
